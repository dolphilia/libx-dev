---
import { translatePath } from '@docs/i18n/utils';
import type { LocaleKey } from '@docs/i18n/locales';
import { Dropdown, DropdownItem, Icon } from '@docs/ui/components';

// å®šæ•°å®šç¾©
const BASE_URL = '/docs-astro';
const LANG_NAMES: Record<string, string> = {
  en: 'English',
  ja: 'æ—¥æœ¬èª'
};

// è¨€èªãƒ•ãƒ©ã‚°ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆISO 639-1ã‚³ãƒ¼ãƒ‰ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼‰
const LANG_FLAGS: Record<string, string> = {
  en: 'ğŸ‡ºğŸ‡¸',
  ja: 'ğŸ‡¯ğŸ‡µ'
};

// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‹å®šç¾©
interface Props {
  currentLang: string;
  currentVersion?: string;
  supportedLangs?: string[];
  className?: string;
  showLanguageInfo?: boolean;
}

// ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å–å¾—ã¨åˆæœŸå€¤è¨­å®š
const { 
  currentLang, 
  currentVersion,
  supportedLangs = ['en', 'ja'], 
  className = '',
  showLanguageInfo = false
} = Astro.props;

// ç¾åœ¨ã®ãƒ‘ã‚¹æƒ…å ±ã‚’å–å¾—
const currentPathname = Astro.url.pathname;

// ãƒ‘ã‚¹ã‚’æ­£è¦åŒ–ï¼ˆæœ«å°¾ã«ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ä»˜ã‘ã‚‹ï¼‰
const normalizedPathname = currentPathname.endsWith('/') ? currentPathname : `${currentPathname}/`;

// ãƒ™ãƒ¼ã‚¹URLã‚’é™¤ã„ãŸãƒ‘ã‚¹éƒ¨åˆ†ã‚’å–å¾—
const pathWithoutBase = normalizedPathname.startsWith(BASE_URL)
  ? normalizedPathname.substring(BASE_URL.length)
  : normalizedPathname;

// è¨€èªã‚³ãƒ¼ãƒ‰ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚¹ãƒ©ãƒƒã‚°ã‚’æŠ½å‡º
const pathSegments = pathWithoutBase.split('/').filter(segment => segment !== '');
let langFromPath: string | undefined = undefined;
let versionFromPath: string | undefined = undefined;
let slugFromPath = '';

if (pathSegments.length > 0 && supportedLangs.includes(pathSegments[0])) {
  langFromPath = pathSegments.shift();
}

if (pathSegments.length > 0 && pathSegments[0].match(/^v\d+$/)) {
  versionFromPath = pathSegments.shift();
}
slugFromPath = pathSegments.join('/');
if (slugFromPath && !slugFromPath.endsWith('/')) {
  slugFromPath += '/';
}
if (!slugFromPath && (langFromPath || versionFromPath)) {
    slugFromPath = ''; // Ensure slug is empty if only lang/version exists, but ensure trailing slash for consistency
}


// å„è¨€èªã®ãƒ‘ã‚¹æƒ…å ±ã‚’ç”Ÿæˆ
interface LangPathInfo {
  lang: string;
  name: string;
  flag: string;
  path: string;
  isCurrent: boolean;
}

const langPaths: LangPathInfo[] = supportedLangs.map(langCode => {
  const targetLang = langCode as LocaleKey;
  let newPath = BASE_URL;

  if (targetLang !== 'en' || (targetLang === 'en' && (versionFromPath || slugFromPath))) {
    newPath += `/${targetLang}`;
  } else if (targetLang === 'en' && !versionFromPath && !slugFromPath) {
    // Special case for root English path: /docs-astro/ or /docs-astro/en/ should go to /docs-astro/en/
    // However, if current page is /docs-astro/ (meaning lang is implicitly en and no version/slug)
    // then link to en should be /docs-astro/en/
    // This logic aims to ensure /en/ is present for clarity unless it's truly the bare root.
    // The problem description implies /docs-astro/en/ is preferred over /docs-astro/ for English root.
    // Let's ensure 'en' is always present in the path if it's the target language,
    // unless it's the absolute root and no other segments exist.
    // The examples show that even for /en/, the link to en should be /en/
    newPath += `/${targetLang}`;
  }


  if (versionFromPath) {
    newPath += `/${versionFromPath}`;
  }
  if (slugFromPath) {
    newPath += `/${slugFromPath}`;
  }

  // Ensure trailing slash for directory-like URLs, but not for the bare base URL
  if (!newPath.endsWith('/') && newPath !== BASE_URL) {
    newPath += '/';
  }
  // Handle the case where the path is just the base URL (e.g. /docs-astro)
  // and we are linking to English, it should be /docs-astro/en/
  if (newPath === BASE_URL && targetLang === 'en') {
      newPath = `${BASE_URL}/en/`;
  }
  // If the original path was just /docs-astro/en and linking to ja, it should be /docs-astro/ja/
  // If the original path was just /docs-astro/ja and linking to en, it should be /docs-astro/en/

  // Final check for consistency: if the path is just BASE_URL/lang, ensure trailing slash
  const baseLangPattern = new RegExp(`^${BASE_URL}/(${supportedLangs.join('|')})$`);
  if (baseLangPattern.test(newPath)) {
      newPath += '/';
  }


  return {
    lang: langCode,
    name: LANG_NAMES[langCode] || langCode,
    flag: LANG_FLAGS[langCode] || 'ğŸŒ',
    path: newPath,
    isCurrent: langCode === currentLang
  };
});

// è¨€èªã«é–¢ã™ã‚‹è¿½åŠ æƒ…å ±
interface LanguageInfo {
  nativeName: string;
  englishName: string;
  direction: string;
  description: string;
}

const languageInfo: Record<string, LanguageInfo> = {
  en: {
    nativeName: 'English',
    englishName: 'English',
    direction: 'ltr',
    description: 'Official documentation in English'
  },
  ja: {
    nativeName: 'æ—¥æœ¬èª',
    englishName: 'Japanese',
    direction: 'ltr',
    description: 'æ—¥æœ¬èªã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ'
  }
};
---

<div class="language-selector-container">
  <Dropdown 
    label={LANG_NAMES[currentLang] || currentLang}
    align="right"
    width="14rem"
    class={`language-dropdown ${className}`}
  >
    <div class="language-dropdown-header" slot="before-items">
      <Icon name="document" class="language-icon" />
      <span>è¨€èªã‚’é¸æŠ</span>
    </div>
    
    {langPaths.map((pathInfo) => (
      <DropdownItem 
        label={pathInfo.name}
        href={pathInfo.path}
        isActive={pathInfo.isCurrent}
      >
        <span slot="before-label" class="language-flag">{pathInfo.flag}</span>
        {pathInfo.isCurrent && (
          <span slot="after-label" class="language-current-badge">ç¾åœ¨</span>
        )}
        {showLanguageInfo && languageInfo[pathInfo.lang] && (
          <div class="language-info">
            <div class="language-native-name">
              {languageInfo[pathInfo.lang].nativeName}
              {languageInfo[pathInfo.lang].nativeName !== languageInfo[pathInfo.lang].englishName && (
                <span class="language-english-name">({languageInfo[pathInfo.lang].englishName})</span>
              )}
            </div>
            <div class="language-description">{languageInfo[pathInfo.lang].description}</div>
          </div>
        )}
      </DropdownItem>
    ))}
    
    <div class="language-dropdown-footer" slot="after-items">
      <a href="https://github.com/dolphilia/docs-astro/tree/main/packages/i18n" class="language-footer-link" target="_blank" rel="noopener">
        <Icon name="external-link" class="language-footer-icon" />
        ç¿»è¨³ã«è²¢çŒ®ã™ã‚‹
      </a>
    </div>
  </Dropdown>
  
  {showLanguageInfo && (
    <div class="language-info-panel">
      <h3 class="language-info-title">ç¾åœ¨ã®è¨€èª: {LANG_NAMES[currentLang]}</h3>
      <div class="language-info-content">
        <p class="language-info-description">
          {languageInfo[currentLang]?.description || ''}
        </p>
        <div class="language-info-meta">
          <div class="language-info-item">
            <span class="language-info-label">ãƒã‚¤ãƒ†ã‚£ãƒ–å:</span>
            <span class="language-info-value">{languageInfo[currentLang]?.nativeName || currentLang}</span>
          </div>
          <div class="language-info-item">
            <span class="language-info-label">è‹±èªå:</span>
            <span class="language-info-value">{languageInfo[currentLang]?.englishName || currentLang}</span>
          </div>
          <div class="language-info-item">
            <span class="language-info-label">ãƒ†ã‚­ã‚¹ãƒˆæ–¹å‘:</span>
            <span class="language-info-value">{languageInfo[currentLang]?.direction === 'rtl' ? 'å³ã‹ã‚‰å·¦' : 'å·¦ã‹ã‚‰å³'}</span>
          </div>
        </div>
      </div>
    </div>
  )}
</div>

<style>
  .language-selector-container {
    display: inline-block;
  }

  .language-dropdown {
    position: relative;
  }

  .language-dropdown-header {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--sl-color-gray-5, #6b7280);
    border-bottom: 1px solid var(--sl-color-gray-2, #e5e7eb);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .language-dropdown-footer {
    padding: 0.5rem 1rem;
    border-top: 1px solid var(--sl-color-gray-2, #e5e7eb);
  }

  .language-footer-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--sl-color-primary, #2563eb);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .language-footer-link:hover {
    color: var(--sl-color-primary-dark, #1d4ed8);
    text-decoration: underline;
  }

  .language-footer-icon {
    font-size: 1rem;
    color: currentColor;
  }

  .language-icon {
    font-size: 1rem;
    color: var(--sl-color-gray-4, #9ca3af);
  }

  .language-flag {
    display: inline-block;
    margin-right: 0.5rem;
    font-size: 1.25rem;
    line-height: 1;
  }

  .language-current-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1;
    background-color: var(--sl-color-blue-2, #dbeafe);
    color: var(--sl-color-blue-9, #1e40af);
  }

  .language-info {
    margin-top: 0.25rem;
    font-size: 0.75rem;
  }

  .language-native-name {
    font-weight: 500;
    color: var(--sl-color-gray-7, #374151);
  }

  .language-english-name {
    font-weight: normal;
    color: var(--sl-color-gray-5, #6b7280);
    margin-left: 0.25rem;
  }

  .language-description {
    color: var(--sl-color-gray-6, #4b5563);
    margin-top: 0.125rem;
    line-height: 1.25;
  }

  .language-info-panel {
    margin-top: 1rem;
    border: 1px solid var(--sl-color-gray-2, #e5e7eb);
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .language-info-title {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    background-color: var(--sl-color-gray-1, #f9fafb);
    border-bottom: 1px solid var(--sl-color-gray-2, #e5e7eb);
    margin: 0;
  }

  .language-info-content {
    padding: 1rem;
  }

  .language-info-description {
    margin: 0 0 1rem 0;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--sl-color-gray-8, #1f2937);
  }

  .language-info-meta {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
  }

  .language-info-item {
    font-size: 0.75rem;
    line-height: 1.5;
  }

  .language-info-label {
    font-weight: 500;
    color: var(--sl-color-gray-6, #4b5563);
  }

  .language-info-value {
    color: var(--sl-color-gray-8, #1f2937);
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
  :global(.dark) .language-dropdown-header,
  :global(.dark) .language-dropdown-footer {
    border-color: var(--sl-color-gray-7, #374151);
  }

  :global(.dark) .language-current-badge {
    background-color: rgba(30, 64, 175, 0.2);
    color: var(--sl-color-blue-3, #93c5fd);
  }

  :global(.dark) .language-native-name {
    color: var(--sl-color-gray-3, #d1d5db);
  }

  :global(.dark) .language-english-name {
    color: var(--sl-color-gray-5, #6b7280);
  }

  :global(.dark) .language-description {
    color: var(--sl-color-gray-4, #9ca3af);
  }

  :global(.dark) .language-info-panel {
    border-color: var(--sl-color-gray-7, #374151);
  }

  :global(.dark) .language-info-title {
    background-color: var(--sl-color-gray-8, #1f2937);
    border-color: var(--sl-color-gray-7, #374151);
  }

  :global(.dark) .language-info-description {
    color: var(--sl-color-gray-3, #d1d5db);
  }

  :global(.dark) .language-info-label {
    color: var(--sl-color-gray-4, #9ca3af);
  }

  :global(.dark) .language-info-value {
    color: var(--sl-color-gray-2, #e5e7eb);
  }

  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-0.25rem); }
    to { opacity: 1; transform: translateY(0); }
  }

  .language-dropdown :global(.dropdown-content) {
    animation: fadeIn 0.2s ease-out;
  }
</style>

<script>
  // è¨€èªåˆ‡ã‚Šæ›¿ãˆæ™‚ã®URLãƒ‘ã‚¹ä¿®æ­£
  document.addEventListener('DOMContentLoaded', () => {
    // è¨€èªé¸æŠãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
    const languageLinks = document.querySelectorAll('.language-dropdown .dropdown-item');
    
    languageLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        // ç¾åœ¨ã®URLã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º
        const currentPath = window.location.pathname;
        const versionMatch = currentPath.match(/\/([^\/]+)\/v([^\/]+)/);
        
        if (versionMatch) {
          const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
          if (href) {
            // æ–°ã—ã„URLã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const newUrlMatch = href.match(/\/([^\/]+)\/v([^\/]+)/);
            
            if (!newUrlMatch || newUrlMatch[2] !== versionMatch[2]) {
              // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒæ­£ã—ããªã„å ´åˆã€URLã‚’ä¿®æ­£
              e.preventDefault();
              
              // æ–°ã—ã„è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
              const newLangMatch = href.match(/\/([^\/]+)(\/|$)/);
              if (newLangMatch) {
                const newLang = newLangMatch[1];
                // æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å«ã‚€URLã‚’æ§‹ç¯‰
                const correctedUrl = href.replace(/\/([^\/]+)(\/|$)/, `/${newLang}/v${versionMatch[2]}/`);
                window.location.href = correctedUrl;
              }
            }
          }
        }
      });
    });
  });
</script>
