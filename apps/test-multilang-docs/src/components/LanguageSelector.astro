---
import type { LocaleKey } from '@docs/i18n/locales';
import { translate } from '@docs/i18n/utils';
import { Dropdown, DropdownItem, Icon } from '@docs/ui/components';
import { getProjectConfig } from '../config/project.config.new';

// å®šæ•°å®šç¾©
// BASE_URL å®šç¾©ã¯å‰Šé™¤ã—ã€projectConfig.baseUrl ã‚’ä½¿ç”¨ã™ã‚‹
const LANG_NAMES: Record<string, string> = {
  en: 'English',
  ja: 'æ—¥æœ¬èª',
  ko: 'í•œêµ­ì–´'
};

// è¨€èªãƒ•ãƒ©ã‚°ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆISO 639-1ã‚³ãƒ¼ãƒ‰ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼‰
const LANG_FLAGS: Record<string, string> = {
  en: 'ğŸ‡ºğŸ‡¸',
  ja: 'ğŸ‡¯ğŸ‡µ',
  ko: 'ğŸ‡°ğŸ‡·'
};

// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‹å®šç¾©
interface Props {
  currentLang: string;
  supportedLangs?: string[];
  className?: string;
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
const projectConfig = await getProjectConfig();

// ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å–å¾—ã¨åˆæœŸå€¤è¨­å®š
const ACTUAL_BASE_URL = projectConfig.basic.baseUrl; // projectConfigã‹ã‚‰baseUrlã‚’å–å¾—
const configuredSupportedLangs = projectConfig.basic.supportedLangs; // projectConfigã‹ã‚‰supportedLangsã‚’å–å¾—

const { 
  currentLang, 
  supportedLangs = configuredSupportedLangs,
  className = ''
} = Astro.props;

// ç¾åœ¨ã®ãƒ‘ã‚¹æƒ…å ±ã‚’å–å¾—
const currentPathname = Astro.url.pathname;

// ãƒ‘ã‚¹ã‚’æ­£è¦åŒ–ï¼ˆæœ«å°¾ã«ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ä»˜ã‘ã‚‹ï¼‰
const normalizedPathname = currentPathname.endsWith('/') ? currentPathname : `${currentPathname}/`;

// ãƒ™ãƒ¼ã‚¹URLã‚’é™¤ã„ãŸãƒ‘ã‚¹éƒ¨åˆ†ã‚’å–å¾—
// ä¾‹: /docs/sample-docs/en/v1/foo/  -> /en/v1/foo/
let pathWithoutActualBase = normalizedPathname;
if (normalizedPathname.startsWith(ACTUAL_BASE_URL + '/')) {
  pathWithoutActualBase = normalizedPathname.substring(ACTUAL_BASE_URL.length);
} else if (normalizedPathname === ACTUAL_BASE_URL + '/') { // ãƒ™ãƒ¼ã‚¹URLãã®ã‚‚ã®ã®å ´åˆ
  pathWithoutActualBase = '/';
}
// pathWithoutActualBase ã¯ /en/v1/slug/ ã‚„ /en/ ã®ã‚ˆã†ã«ãªã‚‹ã“ã¨ã‚’æœŸå¾…

// è¨€èªã‚³ãƒ¼ãƒ‰ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚¹ãƒ©ãƒƒã‚°ã‚’æŠ½å‡º
// pathWithoutActualBase ã¯ `/` ã§å§‹ã¾ã‚‹ã®ã§ã€æœ€åˆã®è¦ç´ ã¯ç©ºæ–‡å­—åˆ—ã«ãªã‚‹å ´åˆãŒã‚ã‚‹
const pathSegments = pathWithoutActualBase.split('/').filter(segment => segment !== '');
// ä¾‹: /en/v1/guide/getting-started/ -> ['en', 'v1', 'guide', 'getting-started']
// ä¾‹: /en/ -> ['en']

let langFromPath: string | undefined = undefined;
let versionFromPath: string | undefined = undefined;
let slugParts: string[] = [];

const langsForRegex = configuredSupportedLangs.join('|');
const langRegex = new RegExp(`^(${langsForRegex})$`);

if (pathSegments.length > 0 && pathSegments[0].match(langRegex)) {
  langFromPath = pathSegments.shift();
}

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®æ­£è¦è¡¨ç¾ã‚’å°‘ã—æ”¹å–„ (ä¾‹: v1, v1.0, v1.0.1)
if (pathSegments.length > 0 && pathSegments[0].match(/^v\\d+([\\.-]\\d+)*$/)) {
  versionFromPath = pathSegments.shift();
}
slugParts = pathSegments; // æ®‹ã‚ŠãŒã‚¹ãƒ©ãƒƒã‚°éƒ¨åˆ†

// slugFromPath ã¯æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚ã‚Šã€ã¾ãŸã¯ç©ºæ–‡å­—åˆ—
let slugFromPath = slugParts.join('/');
if (slugFromPath && !slugFromPath.endsWith('/')) {
  slugFromPath += '/';
} else if (!slugFromPath && slugParts.length === 0 && (langFromPath || versionFromPath)) {
  // è¨€èªã¾ãŸã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ãŒã€ãã‚Œä»¥é™ã®ã‚¹ãƒ©ãƒƒã‚°éƒ¨åˆ†ãŒãªã„å ´åˆ
  // (ä¾‹: /base/lang/ ã‚„ /base/lang/version/) slugFromPath ã¯ "" ã¨ãªã‚‹
  slugFromPath = "";
}


// å„è¨€èªã®ãƒ‘ã‚¹æƒ…å ±ã‚’ç”Ÿæˆ
interface LangPathInfo {
  lang: string;
  name: string;
  flag: string;
  path: string;
  isCurrent: boolean;
}

const langPaths: LangPathInfo[] = supportedLangs.map(langCode => {
  const targetLang = langCode as LocaleKey;
  
  const newPathParts = [ACTUAL_BASE_URL];
  newPathParts.push(targetLang);

  if (versionFromPath) {
    newPathParts.push(versionFromPath);
  }
  
  // slugFromPath ã¯ 'guide/getting-started/' ã¾ãŸã¯ ''
  // '' ã®å ´åˆã¯çµåˆæ™‚ã«ç„¡è¦–ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
  if (slugFromPath && slugFromPath !== '/') {
    // æœ«å°¾ã® / ã‚’é™¤ã„ã¦è¿½åŠ ã—ã€æœ€å¾Œã«å…¨ä½“ã§ / ã‚’ä»˜ã‘ã‚‹æˆ¦ç•¥
    const cleanSlug = slugFromPath.endsWith('/') ? slugFromPath.slice(0, -1) : slugFromPath;
    if (cleanSlug) { // ç©ºæ–‡å­—åˆ—ã§ãªã‘ã‚Œã°è¿½åŠ 
        newPathParts.push(cleanSlug);
    }
  }

  let newPath = newPathParts
    .filter(part => typeof part === 'string' && part !== '') // null, undefined, ç©ºæ–‡å­—ã‚’é™¤å»
    .join('/');

  // ãƒ™ãƒ¼ã‚¹URLãŒç©ºã§ã€ãƒ‘ã‚¹ãŒ "/" ã‹ã‚‰å§‹ã¾ã£ã¦ã„ãªã„å ´åˆã€å…ˆé ­ã« "/" ã‚’è¿½åŠ 
  if (ACTUAL_BASE_URL === '' && !newPath.startsWith('/') && newPath !== '') {
    newPath = '/' + newPath;
  }
  
  // é€£ç¶šã™ã‚‹ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’1ã¤ã«ç½®æ› (ä¾‹: "///" -> "/")
  newPath = newPath.replace(/\/\/+/g, '/');
  
  // ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ "/" ã‚’é™¤ãã€å…¨ã¦ã®ãƒ‘ã‚¹ã®æœ«å°¾ã«ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ä¿è¨¼
  if (newPath !== '/' && !newPath.endsWith('/')) {
    newPath += '/';
  }

  return {
    lang: langCode,
    name: LANG_NAMES[langCode] || langCode,
    flag: LANG_FLAGS[langCode] || 'ğŸŒ',
    path: newPath,
    isCurrent: langCode === currentLang
  };
});

---

<div class="language-selector-container">
  <Dropdown 
    label={LANG_NAMES[currentLang] || currentLang}
    align="right"
    width="14rem"
    class={`language-dropdown ${className}`}
  >
    <div class="language-dropdown-header" slot="before-items">
      <Icon name="languages" class="language-icon" />
      <span>è¨€èªã‚’é¸æŠ</span>
    </div>
    
    {langPaths.map((pathInfo) => (
      <DropdownItem 
        label={pathInfo.name}
        href={pathInfo.path}
        isActive={pathInfo.isCurrent}
      >
        <span slot="before-label" class="language-flag">{pathInfo.flag}</span>
        {pathInfo.isCurrent && (
          <span slot="after-label" class="language-current-badge">{translate('docs.current', currentLang as LocaleKey)}</span>
        )}
      </DropdownItem>
    ))}
  </Dropdown>
</div>

<style>
  .language-selector-container {
    display: inline-block;
  }

  .language-dropdown {
    position: relative;
  }

  .language-dropdown-header {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--sl-color-gray-5, #6b7280);
    border-bottom: 1px solid var(--sl-color-gray-2, #e5e7eb);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }


  .language-icon {
    font-size: 1rem;
    color: var(--sl-color-gray-4, #9ca3af);
  }

  .language-flag {
    display: inline-block;
    margin-right: 0.5rem;
    font-size: 1.25rem;
    line-height: 1;
  }

  .language-current-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1;
    background-color: var(--sl-color-blue-2, #dbeafe);
    color: var(--sl-color-blue-9, #1e40af);
  }


  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
  :global(.dark) .language-dropdown-header,
  :global(.dark) .language-dropdown-footer {
    border-color: var(--sl-color-gray-7, #374151);
  }

  :global(.dark) .language-current-badge {
    background-color: rgba(30, 64, 175, 0.2);
    color: var(--sl-color-blue-3, #93c5fd);
  }

  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-0.25rem); }
    to { opacity: 1; transform: translateY(0); }
  }

  .language-dropdown :global(.dropdown-content) {
    animation: fadeIn 0.2s ease-out;
  }
</style>

<script>
  // è¨€èªåˆ‡ã‚Šæ›¿ãˆæ™‚ã®URLãƒ‘ã‚¹ä¿®æ­£
  document.addEventListener('DOMContentLoaded', () => {
    // è¨€èªé¸æŠãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
    const languageLinks = document.querySelectorAll('.language-dropdown .dropdown-item');
    
    languageLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        // ç¾åœ¨ã®URLã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º
        const currentPath = window.location.pathname;
        const versionMatch = currentPath.match(/\/([^\/]+)\/v([^\/]+)/);
        
        if (versionMatch) {
          const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
          if (href) {
            // æ–°ã—ã„URLã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const newUrlMatch = href.match(/\/([^\/]+)\/v([^\/]+)/);
            
            if (!newUrlMatch || newUrlMatch[2] !== versionMatch[2]) {
              // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒæ­£ã—ããªã„å ´åˆã€URLã‚’ä¿®æ­£
              e.preventDefault();
              
              // æ–°ã—ã„è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
              const newLangMatch = href.match(/\/([^\/]+)(\/|$)/);
              if (newLangMatch) {
                const newLang = newLangMatch[1];
                // æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å«ã‚€URLã‚’æ§‹ç¯‰
                const correctedUrl = href.replace(/\/([^\/]+)(\/|$)/, `/${newLang}/v${versionMatch[2]}/`);
                window.location.href = correctedUrl;
              }
            }
          }
        }
      });
    });
  });
</script>
