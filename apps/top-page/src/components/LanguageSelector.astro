---
import { translatePath, translate } from '@docs/i18n/utils';
import type { LocaleKey } from '@docs/i18n/locales';
import { Dropdown, DropdownItem, Icon } from '@docs/ui/components';
import { getTopPageConfig } from '../config/projects.config.new';

// Ë®≠ÂÆö„ÇíÂèñÂæó
const topPageConfig = await getTopPageConfig();
const BASE_URL = topPageConfig.baseUrl;
const LANG_NAMES: Record<string, string> = {
  en: 'English',
  ja: 'Êó•Êú¨Ë™û'
};

// Ë®ÄË™û„Éï„É©„Ç∞„Ç¢„Ç§„Ç≥„É≥ÔºàISO 639-1„Ç≥„Éº„Éâ„Çí„Ç≠„Éº„Å®„Åó„Å¶‰ΩøÁî®Ôºâ
const LANG_FLAGS: Record<string, string> = {
  en: 'üá∫üá∏',
  ja: 'üáØüáµ'
};

// „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£ÂûãÂÆöÁæ©
interface Props {
  currentLang: string;
  supportedLangs?: string[];
  className?: string;
}

// „Éó„É≠„Éë„ÉÜ„Ç£„ÅÆÂèñÂæó„Å®ÂàùÊúüÂÄ§Ë®≠ÂÆö
const { 
  currentLang, 
  supportedLangs = topPageConfig.supportedLangs, 
  className = ''
} = Astro.props;

// ÁèæÂú®„ÅÆ„Éë„ÇπÊÉÖÂ†±„ÇíÂèñÂæó
const currentPathname = Astro.url.pathname;

// „Éë„Çπ„ÇíÊ≠£Ë¶èÂåñÔºàÊú´Â∞æ„Å´„Çπ„É©„ÉÉ„Ç∑„É•„Çí‰ªò„Åë„ÇãÔºâ
const normalizedPathname = currentPathname.endsWith('/') ? currentPathname : `${currentPathname}/`;

// „Éô„Éº„ÇπURL„ÇíÈô§„ÅÑ„Åü„Éë„ÇπÈÉ®ÂàÜ„ÇíÂèñÂæó
const pathWithoutBase = normalizedPathname.startsWith(BASE_URL)
  ? normalizedPathname.substring(BASE_URL.length)
  : normalizedPathname;

// Ë®ÄË™û„Ç≥„Éº„Éâ„ÇíÊäΩÂá∫
const pathSegments = pathWithoutBase.split('/').filter(segment => segment !== '');
let langFromPath: string | undefined = undefined;

if (pathSegments.length > 0 && supportedLangs.includes(pathSegments[0])) {
  langFromPath = pathSegments.shift();
}

// ÂêÑË®ÄË™û„ÅÆ„Éë„ÇπÊÉÖÂ†±„ÇíÁîüÊàê
interface LangPathInfo {
  lang: string;
  name: string;
  flag: string;
  path: string;
  isCurrent: boolean;
}

const langPaths: LangPathInfo[] = supportedLangs.map(langCode => {
  const targetLang = langCode as LocaleKey;
  let newPath = `${BASE_URL}/${targetLang}`;

  // Ensure trailing slash for directory-like URLs
  if (!newPath.endsWith('/')) {
    newPath += '/';
  }

  return {
    lang: langCode,
    name: LANG_NAMES[langCode] || langCode,
    flag: LANG_FLAGS[langCode] || 'üåê',
    path: newPath,
    isCurrent: langCode === currentLang
  };
});
---

<div class="language-selector-container">
  <Dropdown 
    label={LANG_NAMES[currentLang] || currentLang}
    align="right"
    width="14rem"
    class={`language-dropdown ${className}`}
  >
    <div class="language-dropdown-header" slot="before-items">
      <Icon name="document" class="language-icon" />
      <span>Ë®ÄË™û„ÇíÈÅ∏Êäû</span>
    </div>
    
    {langPaths.map((pathInfo) => (
      <DropdownItem 
        label={pathInfo.name}
        href={pathInfo.path}
        isActive={pathInfo.isCurrent}
      >
        <span slot="before-label" class="language-flag">{pathInfo.flag}</span>
        {pathInfo.isCurrent && (
          <span slot="after-label" class="language-current-badge">{translate('docs.current', currentLang)}</span>
        )}
      </DropdownItem>
    ))}
    
    <div class="language-dropdown-footer" slot="after-items">
      <a href="https://github.com/dolphilia/docs-astro/tree/main/packages/i18n" class="language-footer-link" target="_blank" rel="noopener">
        <Icon name="external-link" class="language-footer-icon" />
        ÁøªË®≥„Å´Ë≤¢ÁåÆ„Åô„Çã
      </a>
    </div>
  </Dropdown>
</div>

<style>
  .language-selector-container {
    display: inline-block;
  }

  .language-dropdown {
    position: relative;
  }

  .language-dropdown-header {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--sl-color-gray-5, #6b7280);
    border-bottom: 1px solid var(--sl-color-gray-2, #e5e7eb);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .language-dropdown-footer {
    padding: 0.5rem 1rem;
    border-top: 1px solid var(--sl-color-gray-2, #e5e7eb);
  }

  .language-footer-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--sl-color-primary, #2563eb);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .language-footer-link:hover {
    color: var(--sl-color-primary-dark, #1d4ed8);
    text-decoration: underline;
  }

  .language-footer-icon {
    font-size: 1rem;
    color: currentColor;
  }

  .language-icon {
    font-size: 1rem;
    color: var(--sl-color-gray-4, #9ca3af);
  }

  .language-flag {
    display: inline-block;
    margin-right: 0.5rem;
    font-size: 1.25rem;
    line-height: 1;
  }

  .language-current-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1;
    background-color: var(--sl-color-blue-2, #dbeafe);
    color: var(--sl-color-blue-9, #1e40af);
  }

  /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú */
  :global(.dark) .language-dropdown-header,
  :global(.dark) .language-dropdown-footer {
    border-color: var(--sl-color-gray-7, #374151);
  }

  :global(.dark) .language-current-badge {
    background-color: rgba(30, 64, 175, 0.2);
    color: var(--sl-color-blue-3, #93c5fd);
  }

  /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-0.25rem); }
    to { opacity: 1; transform: translateY(0); }
  }

  .language-dropdown :global(.dropdown-content) {
    animation: fadeIn 0.2s ease-out;
  }
</style>
